##########################################
##           pipeline rna-seq           ##
##       Ia: Download Assembly FA       ##
##########################################

Inputs:
[
    Channel: { assembly_fa_trigger }
      - this channel checks for the asembly fa
      - flows into a process trigger that filters for file presence
      - if file not present, process triggered
]

Process:
[
    params.hisat_idx_output = "${params.index_out}/${params.hisat_assembly}"

    Channel
      .fromPath("${params.hisat_idx_output}/fa/*.fa")
      .set{ assembly_fa_trigger }
    assembly_fa_trigger.count().filter{ it == 0 }.set{ assembly_fa_download }

    process pullGENCODEassemblyfa {

        echo true
        tag "Downloading Assembly FA File: ${params.fa}"
        publishDir "${params.hisat_idx_output}/fa",'mode':'copy'

        input:
        val(assembly_fa_val) from assembly_fa_download

        output:
        file("${params.fa}") into reference_fa

        script:
        idx_file_link = "${params.fa_link}"
        idx_gz = "${params.fa_gz}"
        idx = "${params.fa}"
        """
        wget $idx_file_link
        gunzip $idx_gz
        """
    }

    Channel
      .fromPath("${params.hisat_idx_output}/fa/${params.fa}")
      .mix(reference_fa)
      .toSortedList()
      .flatten()
      .distinct()
      .into{ reference_assembly; variant_assembly }
]

Outputs:
[
    Channel: reference_fa
      - this channel outputs the file from the pull process

    Channel: { reference_assembly; variant_assembly }
      - this channel reads in the fa file from the target location
      - if the pull happened or not, the file should be present
      - channel is mixed with fa pull, even if pull never happened
      - channel is flattened and filtered for distinct values 
      - channel is mixed so that the channel is "dependent" on process completion
]

Module execution:
[
        Module is executed within the pipeline:

        1) `wget $idx_file_link`; downloads the target fa if the file is not already present

        2) `gunzip $idx_gz`; gunzip the fa file for use downstream in other processes
]